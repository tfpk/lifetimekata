<!DOCTYPE HTML>
<html lang="en" class="light" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Chapter 1: Lifetimes Needed - LifetimeKata</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body class="sidebar-visible no-js">
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('light')
            html.classList.add(theme);
            var body = document.querySelector('body');
            body.classList.remove('no-js')
            body.classList.add('js');
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var body = document.querySelector('body');
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            body.classList.remove('sidebar-visible');
            body.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="index.html">Introduction</a></li><li class="chapter-item expanded "><a href="chapter_0.html">Chapter 0: Revision</a></li><li class="chapter-item expanded "><a href="chapter_1.html" class="active">Chapter 1: Lifetimes Needed</a></li><li class="chapter-item expanded "><a href="chapter_2.html">Chapter 2: Lifetimes Explained</a></li><li class="chapter-item expanded "><a href="chapter_3.html">Chapter 3: Lifetime Elision</a></li><li class="chapter-item expanded "><a href="chapter_4.html">Chapter 4: Mutable References and Containers</a></li><li class="chapter-item expanded "><a href="chapter_5.html">Chapter 5: Lifetimes on Types</a></li><li class="chapter-item expanded "><a href="chapter_6.html">Chapter 6: Lifetimes on Impls</a></li><li class="chapter-item expanded "><a href="chapter_7.html">Chapter 7: Special Lifetimes</a></li><li class="chapter-item expanded "><a href="chapter_8.html">Chapter 8: Finale</a></li><li class="chapter-item expanded "><a href="chapter_9.html">Chapter 9: Further Reading</a></li><li class="chapter-item expanded "><a href="chapter_10.html">Chapter 10: Footnote on Trait Lifetime Bounds</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">LifetimeKata</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/tfpk/lifetimekata/" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="what-are-lifetime-annotations"><a class="header" href="#what-are-lifetime-annotations">What are Lifetime Annotations?</a></h1>
<p>In the last section, we discussed the concept of lifetimes within a single function. In all those examples,
it was clear what region of code of a variable or reference existed in, based on the curly brackets.
Lifetime Annotations are used to help the compiler understand what's going on when it can't rely on scope
brackets (i.e. across function boundaries; and within structs and enums).</p>
<p>A good place to understand lifetime annotations is to start by
understanding why we actually need them. Let's work through some examples to see
why they exist:</p>
<p>The simplest possible example of a function that needs you to be explicit about
lifetimes is this one, which returns a reference to the larger of two integers.</p>
<pre><code class="language-rust ignore">fn max_of_refs(a: &amp;i32, b: &amp;i32) -&gt; &amp;i32 {
    if *a &gt; *b {
        a
    } else {
        b
    }
}</code></pre>
<p>Imagine we call this function as follows:</p>
<pre><code class="language-rust ignore">fn complex_function(a: &amp;i32) -&gt; &amp;i32 {
    let b = 2;
    max_of_refs(a, &amp;b)
}

fn main() {
    let a = 1;
    let my_num = complex_function(&amp;a);
    println!(&quot;{my_num}&quot;);
}</code></pre>
<p>If you work through this example, you will find that my_num would be a reference to a variable
from <code>complex_function</code> (which no longer exists). In other words, the lifetime of the return
value of <code>complex_function</code> will be longer than the lifetime of <code>b</code>.</p>
<p>Now, you might say, &quot;but can't the compiler see at runtime that clearly this program won't work&quot;?
Well, because we're using constants, yes the compiler probably could tell that this program won't work.</p>
<p>But what if we said <code>let a = rand::rand()</code> or <code>let b = read_number_from_stdin()</code>?
It's impossible for a compiler to tell whether this reference should be valid.</p>
<h2 id="okay-why-cant-we-just-ban-that-case"><a class="header" href="#okay-why-cant-we-just-ban-that-case">Okay, why can't we just ban that case?</a></h2>
<p>Your next thought might be &quot;OK, surely all references of this type are unsound; lets just disallow them&quot;.
It would be worth being specific about what this ban is. The simplest ban would be &quot;no references in function parameters&quot;,
but that might just be a little excessive (and entirely destructive to how useful Rust is).</p>
<p>A more sensible ban which would cover this case would be: &quot;Any function with
more than one reference input may not return a reference (or something
containing a reference)&quot;. This avoids the problem we've seen of being unclear on
where a reference is coming from. It would ban the above example.</p>
<p>But, how ergonomic would that be? What if you wanted a function like:</p>
<pre><code class="language-rust ignore">fn only_if_greater(number: &amp;i32, greater_than: &amp;i32) -&gt; Option&lt;&amp;i32&gt; {
    if number &gt; greater_than {
        Some(number)
    } else {
        None
    }
}</code></pre>
<p>No matter the way in which you call this function, we <em>always</em> know that if our
return value is <code>Some</code>, it refers to <code>number</code>. It will never return a reference
to <code>greater_than</code>.</p>
<p>A more interesting example of this is a <code>split</code> function, which takes a string,
and returns a vector of slices of that string, split by some other string.</p>
<pre><code class="language-rust ignore">fn split(text: &amp;str, delimiter: &amp;str) -&gt; Vec&lt;&amp;str&gt; {
    let mut last_split = 0;
    let mut matches: Vec&lt;&amp;str&gt; = vec![];
    for i in 0..text.len() {
        if i &lt; last_split {
            continue
        }
        if text[i..].starts_with(delimiter) {
            matches.push(&amp;text[last_split..i]);
            last_split = i + delimiter.len(); 
        }
    }
    if last_split &lt; text.len() {
        matches.push(&amp;text[last_split..]);
    }
    
    matches
}</code></pre>
<p>No matter how you call this function, it will always return a vector of slices from <code>text</code>,
never from <code>delimiter</code>.</p>
<h2 id="ugh-but-cant-the-compiler-just-figure-this-out"><a class="header" href="#ugh-but-cant-the-compiler-just-figure-this-out">Ugh, but can't the compiler just figure this out?</a></h2>
<p>At this point, you can probably notice that <code>matches.push</code> is only ever called with <code>text</code> slices.
So you might reasonably expect that the compiler could infer lifetimes automatically in this case.</p>
<p>It's possible that in simple cases it could. But your compiler might decide that it can't infer
lifetimes. Or it could succeed in inferring them... after 6 months.</p>
<p>So, the compiler needs more information. That information is provided by lifetime annotations.
Before we discuss them in detail, here is an exercise that will hopefully re-inforce the concepts,
before we deal with syntax.</p>
<h2 id="exercise-identify-which-programs-work-and-which-break"><a class="header" href="#exercise-identify-which-programs-work-and-which-break">Exercise: Identify which programs work, and which break</a></h2>
<p>Without using any lifetime syntax, answer the following questions for each of the code examples:</p>
<ol>
<li>Which inputs are references? Which could the function return?</li>
<li>Which examples could have dangling references?</li>
</ol>
<p>NOTE: the code examples do not compile; you will need to read them and think about them.</p>
<p>Once you've decided your answers, the &quot;eyeball&quot; button in the top-right hand
corner of the code block will reveal the answers.</p>
<pre><code class="language-rust ignore">
<span class="boring">// a is the only input reference.
</span><span class="boring">// the only thing the function can return is a
</span>fn identity(a: &amp;i32) -&gt; &amp;i32 {
    a
}

<span class="boring">// This does not have any dangling references.
</span>fn example_1() {
    let x = 4;
    let x_ref = identity(&amp;x);
    assert_eq!(*x_ref, 4);
}

<span class="boring">// This is always going to cause a dangling reference.
</span>fn example_2() {
    let mut x_ref: Option&lt;&amp;i32&gt; = None;
    {
        let x = 7;
        x_ref = Some(identity(&amp;x));
    }
    assert_eq!(*x_ref.unwrap(), 7);
}</code></pre>
<pre><code class="language-rust ignore"><span class="boring">// the contents of `opt` and `otherwise` are both references
</span><span class="boring">// either of them could be returned.
</span>fn option_or(opt: Option&lt;&amp;i32&gt;, otherwise: &amp;i32) -&gt; &amp;i32 {
    opt.unwrap_or(otherwise)
}

<span class="boring">// No possibility for a dangling reference here.
</span>fn example_1() {
    let x = 8;
    let y = 10;
    let my_number = Some(&amp;x);
    assert_eq!(&amp;x, option_or(my_number, &amp;y));
}

<span class="boring">// This is always a dangling reference.
</span>fn example_2() {
    let answer = {
        let y = 4;
        option_or(None, &amp;y)
    };
    assert_eq!(answer, &amp;4);
}

<span class="boring">// This is never a dangling reference.
</span>fn example_3() {
    let y = 4;
    let answer = {
        option_or(None, &amp;y)
    };
    assert_eq!(answer, &amp;4);
}

<span class="boring">// This is always a dangling reference.
</span>fn example_4() {
    let y = 4;
    let answer = {
        let x = 7;
        option_or(Some(&amp;x), &amp;y)
    };
    assert_eq!(answer, &amp;7);
}</code></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="chapter_0.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="chapter_2.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="chapter_0.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="chapter_2.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
