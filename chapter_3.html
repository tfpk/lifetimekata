<!DOCTYPE HTML>
<html lang="en" class="light" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Chapter 3: Lifetime Elision - LifetimeKata</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body class="sidebar-visible no-js">
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('light')
            html.classList.add(theme);
            var body = document.querySelector('body');
            body.classList.remove('no-js')
            body.classList.add('js');
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var body = document.querySelector('body');
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            body.classList.remove('sidebar-visible');
            body.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="index.html">Introduction</a></li><li class="chapter-item expanded "><a href="chapter_0.html">Chapter 0: Revision</a></li><li class="chapter-item expanded "><a href="chapter_1.html">Chapter 1: Lifetimes Needed</a></li><li class="chapter-item expanded "><a href="chapter_2.html">Chapter 2: Lifetimes Explained</a></li><li class="chapter-item expanded "><a href="chapter_3.html" class="active">Chapter 3: Lifetime Elision</a></li><li class="chapter-item expanded "><a href="chapter_4.html">Chapter 4: Mutable References and Containers</a></li><li class="chapter-item expanded "><a href="chapter_5.html">Chapter 5: Lifetimes on Types</a></li><li class="chapter-item expanded "><a href="chapter_6.html">Chapter 6: Lifetimes on Impls</a></li><li class="chapter-item expanded "><a href="chapter_7.html">Chapter 7: Special Lifetimes</a></li><li class="chapter-item expanded "><a href="chapter_8.html">Chapter 8: Finale</a></li><li class="chapter-item expanded "><a href="chapter_9.html">Chapter 9: Further Reading</a></li><li class="chapter-item expanded "><a href="chapter_10.html">Chapter 10: Footnote on Trait Lifetime Bounds</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">LifetimeKata</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/tfpk/lifetimekata/" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="why-lifetime-annotations-are-mostly-never-used"><a class="header" href="#why-lifetime-annotations-are-mostly-never-used">Why Lifetime Annotations Are Mostly Never Used</a></h1>
<p>In the last chapter, we saw why we needed lifetimes. We saw that the compiler
was unable to automatically tell how references in the arguments or return
values might relate to each other. This is why we needed to tell the compiler
that the references related to each other.</p>
<p>This said, you've probably written a function in Rust that needed a reference
(likely a <code>&amp;str</code>), without writing lifetimes. Why didn't you have to annotate
lifetimes then? There are some common patterns in Rust that make it obvious to
the compiler what the lifetimes should be. Let's explore some of them:</p>
<h2 id="example-1-no-output-references"><a class="header" href="#example-1-no-output-references">Example 1: No Output References</a></h2>
<pre><pre class="playground"><code class="language-rust">fn add(a: &amp;i32, b: &amp;i32) -&gt; i32 {
    *a + *b
}

<span class="boring">fn main() {
</span><span class="boring">    assert_eq!(add(&amp;3, &amp;4), 7);
</span><span class="boring">}</span></code></pre></pre>
<p>The lifetimes of <code>a</code> and <code>b</code> in this function don't need to relate to each other. Assuming there's only one thread,
and assuming safe code, there's no way that the variable they are referencing could possibly be dropped during the
function, and after the function, they can live for as long as they like.</p>
<h2 id="example-2-only-one-reference-in-the-input"><a class="header" href="#example-2-only-one-reference-in-the-input">Example 2: Only one reference in the input</a></h2>
<pre><pre class="playground"><code class="language-rust">fn identity(a: &amp;i32) -&gt; &amp;i32 {
    a
}

<span class="boring">fn main() {
</span><span class="boring">    let x = 52;
</span><span class="boring">    assert_eq!(&amp;x, identity(&amp;x));
</span><span class="boring">}</span></code></pre></pre>
<p>It's important to note that it (generally
<sup><a name="to-footnote-1"><a href="#footnote-1">1</a></a></sup>
) isn't possible to create a reference and pass it out of a
function if it wasn't given to you. This is because a reference must refer
to something you own. Anything you own is dropped at the end of your function.
Therefore, anything you own can't be referenced; and the only way you can return a reference
is if you were passed a reference.</p>
<p>For this reason, if you only have one reference in your parameters, the only reference you
could return is that one -- so the lifetime of your parameter has to be the same as
the reference you return.</p>
<h1 id="what-to-do"><a class="header" href="#what-to-do">What to do</a></h1>
<p>Rust could have specifically encoded these examples as exceptions; but then
there may have been many cases which were excepted and they would have
ended up with confusing rules.</p>
<p>Instead, the Rust project has settled on a procedure the compiler will follow to try and guess lifetimes.</p>
<p>The compiler first splits all the references in a function signature into two types: 'input' and 'output'.
'Input' references are those in the parameters of the function (i.e. it's arguments). 'Output' references
are those in the return type of the function.</p>
<p>The two rules that we'll learn in this chapter are:</p>
<ol>
<li>Each place that an input lifetime is left out (a.k.a 'elided') is filled in with its own lifetime.</li>
<li>If there's exactly one lifetime on all the input references, that lifetime is assigned to <em>every</em> output lifetime.</li>
</ol>
<p>Let's see how those rules affect the above two examples, and an example from the last chapter:</p>
<h2 id="example-1-no-output-references-1"><a class="header" href="#example-1-no-output-references-1">Example 1: No Output References</a></h2>
<p>We had:</p>
<pre><code class="language-rust ignore">fn add(a: &amp;mut i32, b: &amp;mut i32) -&gt; i32 {
    *a + *b
}</code></pre>
<p>There are two input lifetimes, the ones needed in the types of <code>a</code> and <code>b</code>. Each get allocated their own lifetime:</p>
<pre><pre class="playground"><code class="language-rust">fn add&lt;'elided1, 'elided2&gt;(a: &amp;'elided1 i32, b: &amp;'elided2 i32) -&gt; i32 {
    *a + *b
}

<span class="boring">fn main() {
</span><span class="boring">    assert_eq!(add(&amp;3, &amp;4), 7);
</span><span class="boring">}</span></code></pre></pre>
<p>There are no output lifetimes, so we end there.</p>
<p>This example is now correct -- the two lifetimes of <code>a</code> and <code>b</code> can be entirely unrelated;
and the output is an owned value, so it doesn't depend on any lifetimes at all.</p>
<h2 id="example-2-only-one-reference-in-the-input-1"><a class="header" href="#example-2-only-one-reference-in-the-input-1">Example 2: Only one reference in the input</a></h2>
<p>We had:</p>
<pre><pre class="playground"><code class="language-rust">fn identity(a: &amp;i32) -&gt; &amp;i32 {
    a
}

<span class="boring">fn main() {
</span><span class="boring">    let x = 52;
</span><span class="boring">    assert_eq!(&amp;x, identity(&amp;x));
</span><span class="boring">}</span></code></pre></pre>
<p>There is only one input lifetime (needed for the type of <code>a</code>):</p>
<pre><pre class="playground"><code class="language-rust">fn identity&lt;'elided1&gt;(a: &amp;'elided1 i32) -&gt; &amp;i32 {
    a
}

<span class="boring">fn main() {
</span><span class="boring">    let x = 52;
</span><span class="boring">    assert_eq!(&amp;x, identity(&amp;x));
</span><span class="boring">}</span></code></pre></pre>
<p>There is only one output lifetime; and all the input lifetimes share the same lifetime (<code>'elided1</code>);
therefore we can allocate all output lifetimes that lifetime:</p>
<pre><pre class="playground"><code class="language-rust">fn identity&lt;'elided1&gt;(a: &amp;'elided1 i32) -&gt; &amp;'elided1 i32 {
    a
}

<span class="boring">fn main() {
</span><span class="boring">    let x = 52;
</span><span class="boring">    assert_eq!(&amp;x, identity(&amp;x));
</span><span class="boring">}</span></code></pre></pre>
<p>This now makes sense: the only possible way you could return a <code>&amp;i32</code> is if you got it from a parameter;
and we can see that the input and output share a lifetime.</p>
<h2 id="example-3-the-limits-of-elision"><a class="header" href="#example-3-the-limits-of-elision">Example 3: The Limits of Elision</a></h2>
<p>Let's have another look at this example from the last chapter.</p>
<pre><code class="language-rust ignore">fn max_of_refs(a: &amp;i32, b: &amp;i32) -&gt; &amp;i32 {
    if *a &gt; *b {
        a
    } else {
        b
    }
}</code></pre>
<p>Just like Example 1, there are two input lifetimes, so we give them
distinct lifetimes:</p>
<pre><code class="language-rust ignore">fn max_of_refs&lt;'elided1, 'elided2&gt;(a: &amp;'elided1 i32, b: &amp;'elided2 i32) -&gt; &amp;i32 {
    if *a &gt; *b {
        a
    } else {
        b
    }
}</code></pre>
<p>But unlike Example 1, we need an output lifetime! By the second rule, we can
only elide the output lifetime if we have exactly one input lifetime. Therefore,
Rust considers it an error to elide lifetimes here -- the user has to give more
information!</p>
<h2 id="exercise-apply-these-rules"><a class="header" href="#exercise-apply-these-rules">Exercise: Apply These Rules</a></h2>
<p>In this exercise, there are four functions which are missing some lifetime annotations.
Your task is to manually follow the lifetime elision rules, and give these
functions lifetimes in the same way that the compiler would.</p>
<p>In a future release of lifetimekata, these will be checked automatically.
For now, when you're done, compare your answer to the solutions.</p>
<p><hr/>
<p><a name="footnote-1"><a href="#to-footnote-1">1</a></a>: this is possible with static types, like string literals, but we'll cover those later</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="chapter_2.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="chapter_4.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="chapter_2.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="chapter_4.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
