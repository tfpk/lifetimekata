<!DOCTYPE HTML>
<html lang="en" class="light" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Chapter 4: Mutable References and Containers - LifetimeKata</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body class="sidebar-visible no-js">
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('light')
            html.classList.add(theme);
            var body = document.querySelector('body');
            body.classList.remove('no-js')
            body.classList.add('js');
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var body = document.querySelector('body');
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            body.classList.remove('sidebar-visible');
            body.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="index.html">Introduction</a></li><li class="chapter-item expanded "><a href="chapter_0.html">Chapter 0: Revision</a></li><li class="chapter-item expanded "><a href="chapter_1.html">Chapter 1: Lifetimes Needed</a></li><li class="chapter-item expanded "><a href="chapter_2.html">Chapter 2: Lifetimes Explained</a></li><li class="chapter-item expanded "><a href="chapter_3.html">Chapter 3: Lifetime Elision</a></li><li class="chapter-item expanded "><a href="chapter_4.html" class="active">Chapter 4: Mutable References and Containers</a></li><li class="chapter-item expanded "><a href="chapter_5.html">Chapter 5: Lifetimes on Types</a></li><li class="chapter-item expanded "><a href="chapter_6.html">Chapter 6: Lifetimes on Impls</a></li><li class="chapter-item expanded "><a href="chapter_7.html">Chapter 7: Special Lifetimes</a></li><li class="chapter-item expanded "><a href="chapter_8.html">Chapter 8: Finale</a></li><li class="chapter-item expanded "><a href="chapter_9.html">Chapter 9: Further Reading</a></li><li class="chapter-item expanded "><a href="chapter_10.html">Chapter 10: Footnote on Trait Lifetime Bounds</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">LifetimeKata</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/tfpk/lifetimekata/" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="mutable-references-and-containers"><a class="header" href="#mutable-references-and-containers">Mutable References and Containers</a></h1>
<p>Mutable References work exactly the same way as regular references, with regards
to lifetime elision. The reason we have a chapter about them, however, is that if
you have a mutable reference, you might need to tell the compiler about lifetimes
even without a return value.</p>
<p>For example, let's take a look at this example:</p>
<pre><code class="language-rust ignore">fn insert_value(my_vec: &amp;mut Vec&lt;&amp;i32&gt;, value: &amp;i32) {
    my_vec.push(value);
}</code></pre>
<p>We're not returning anything; so lifetimes don't matter, right?</p>
<p>Unfortunately, lifetimes are still important. The reference <code>value</code> actually needs to
live for the same time as the contents of the vector. If they didn't,
the vector might contain an invalid reference. For example, what would happen
in this scenario?</p>
<pre><code class="language-rust ignore">fn insert_value(my_vec: &amp;mut Vec&lt;&amp;i32&gt;, value: &amp;i32) {
    my_vec.push(value);
}

fn main() {
    let x = 1;
    let my_vec = vec![&amp;x];
    {
        let y = 2;
        insert_value(&amp;mut my_vec, &amp;y);
    }
    println!(&quot;{my_vec:?}&quot;);
}</code></pre>
<p>The reference to <code>y</code> in the above example is dangling when we try to print the vector!</p>
<p>We can use lifetimes to ensure that the two references live for the same amount of time:</p>
<pre><pre class="playground"><code class="language-rust">fn insert_value&lt;'vec_lifetime, 'contents_lifetime&gt;(my_vec: &amp;'vec_lifetime mut Vec&lt;&amp;'contents_lifetime i32&gt;, value: &amp;'contents_lifetime i32) {
    my_vec.push(value)
}
fn main(){
    let mut my_vec = vec![];
    let val1 = 1;
    let val2 = 2;
    
    insert_value(&amp;mut my_vec, &amp;val1);
    insert_value(&amp;mut my_vec, &amp;val2);
    
    println!(&quot;{my_vec:?}&quot;);
}</code></pre></pre>
<p>This signature indicates that there are two lifetimes:</p>
<ul>
<li><code>'vec_lifetime</code>: The vector we've passed the function will need to live
for a certain period of time.</li>
<li><code>'contents_lifetime</code>: The contents of the vector need to live for a certain
period of time. Importantly, the new <code>value</code> we're inserting needs to live
for just as long as the contents of the vector. If they didn't, you would
end up with a vector that contains an invalid reference.</li>
</ul>
<h2 id="do-we-even-need-two-lifetimes"><a class="header" href="#do-we-even-need-two-lifetimes">Do We Even Need Two Lifetimes?</a></h2>
<p>You might wonder what happens if we don't provide two lifetimes. Does just
one lifetime work?</p>
<pre><code class="language-rust ignore">fn insert_value&lt;'one_lifetime&gt;(my_vec: &amp;'one_lifetime mut Vec&lt;&amp;'one_lifetime i32&gt;, value: &amp;'one_lifetime i32) {
    my_vec.push(value)
}

fn main(){
    let mut my_vec: Vec&lt;&amp;i32&gt; = vec![];
    let val1 = 1;
    let val2 = 2;
    
    insert_value(&amp;mut my_vec, &amp;val1);
    insert_value(&amp;mut my_vec, &amp;val2);
    
    println!(&quot;{my_vec:?}&quot;);
}</code></pre>
<p>No, it doesn't. We get two errors. Let's look at the first one:</p>
<pre><code>error[E0499]: cannot borrow `my_vec` as mutable more than once at a time
  --&gt; /tmp/rust.rs:11:18
   |
10 |     insert_value(&amp;mut my_vec, &amp;val1);
   |                  ----------- first mutable borrow occurs here
11 |     insert_value(&amp;mut my_vec, &amp;val2);
   |                  ^^^^^^^^^^^
   |                  |
   |                  second mutable borrow occurs here
   |                  first borrow later used here

</code></pre>
<p>This seems strange -- why can't you borrow <code>my_vec</code>?</p>
<p>Well, let's walk through what the compiler sees:</p>
<p><code>&amp;val</code> needs to last for as long as <code>my_vec</code> exists:</p>
<pre><code class="language-rust ignore"><span class="boring">fn insert_value&lt;'one_lifetime&gt;(my_vec: &amp;'one_lifetime mut Vec&lt;&amp;'one_lifetime i32&gt;, value: &amp;'one_lifetime i32) {
</span><span class="boring">    my_vec.push(value)
</span><span class="boring">}
</span><span class="boring">
</span><span class="boring">fn main(){
</span>    let mut my_vec: Vec&lt;&amp;i32&gt; = vec![];
    let val1 = 1;
    let val2 = 2;
    
    insert_value(&amp;mut my_vec, &amp;val1); // \
    insert_value(&amp;mut my_vec, &amp;val2); // | - &amp;val1 needs to last this long.
                                      // |
    println!(&quot;{my_vec:?}&quot;);           // /
<span class="boring">}</span></code></pre>
<p>Whereas <code>&amp;mut my_vec</code> only needs to last for the duration of <code>insert_value</code>.</p>
<pre><code class="language-rust ignore"><span class="boring">fn insert_value&lt;'one_lifetime&gt;(my_vec: &amp;'one_lifetime mut Vec&lt;&amp;'one_lifetime i32&gt;, value: &amp;'one_lifetime i32) {
</span><span class="boring">    my_vec.push(value)
</span><span class="boring">}
</span><span class="boring">
</span><span class="boring">fn main(){
</span>    let mut my_vec: Vec&lt;&amp;i32&gt; = vec![];
    let val1 = 1;
    let val2 = 2;
    
    insert_value(&amp;mut my_vec, &amp;val1); // &lt;- &amp;mut my_vec only needs to last this long.
    insert_value(&amp;mut my_vec, &amp;val2); 
    
    println!(&quot;{my_vec:?}&quot;);
<span class="boring">}</span></code></pre>
<p>But, we've told the compiler that it needs the borrows of both <code>&amp;val1</code> and
<code>&amp;mut my_vec</code> to share the same lifetime. So the compiler extends the borrow
of <code>&amp;mut my_vec</code> to ensure they do share a lifetime:
It sees that if it let <code>&amp;mut my_vec</code> live as long as <code>&amp;val1</code>, it would
have that single region of code:</p>
<pre><code class="language-rust ignore"><span class="boring">fn insert_value&lt;'one_lifetime&gt;(my_vec: &amp;'one_lifetime mut Vec&lt;&amp;'one_lifetime i32&gt;, value: &amp;'one_lifetime i32) {
</span><span class="boring">    my_vec.push(value)
</span><span class="boring">}
</span><span class="boring">
</span><span class="boring">fn main(){
</span>    let mut my_vec: Vec&lt;&amp;i32&gt; = vec![];
    let val1 = 1;
    let val2 = 2;
    
    insert_value(&amp;mut my_vec, &amp;val1); // \
    insert_value(&amp;mut my_vec, &amp;val2); // | - 'one_lifetime must be this region of code.
                                      // |
    println!(&quot;{my_vec:?}&quot;);           // /
<span class="boring">}</span></code></pre>
<p>And that's fine. But now the compiler gets to the next line, and it sees you're
trying to borrow <code>&amp;mut my_vec</code> again.</p>
<p>The compiler already decided <code>&amp;mut my_vec</code> has to exist until the end of the function.
So now, you're asking it to create <em>two</em> mutable references... and that's not allowed.</p>
<p>So the compiler throws an error -- you're not allowed to borrow <code>&amp;mut my_vec</code> again.</p>
<h2 id="why-does-having-two-lifetimes-fix-this-error"><a class="header" href="#why-does-having-two-lifetimes-fix-this-error">Why does having two lifetimes fix this error?</a></h2>
<p>Have a think before reading this section -- why does having two lifetimes
solve this bug?</p>
<p>Before, the compiler had to decide that <code>&amp;mut my_vec</code> and <code>&amp;val1</code> shared a lifetime.
In other words, that they lived as long as each-other.</p>
<p>By using two lifetimes, we've told the compiler that <code>&amp;mut my_vec</code> and <code>&amp;val1</code>
don't necessarily have to live for the same amount of time. And so,
it finds the following lifetimes:</p>
<pre><code class="language-rust ignore">fn insert_value&lt;'vec_lifetime, 'contents_lifetime&gt;(my_vec: &amp;'vec_lifetime mut Vec&lt;&amp;'contents_lifetime i32&gt;, value: &amp;'contents_lifetime i32) {
    my_vec.push(value)
}

fn main(){
    let mut my_vec: Vec&lt;&amp;i32&gt; = vec![];
    let val1 = 1;
    let val2 = 2;
    
    insert_value(&amp;mut my_vec, &amp;val1); // &lt;- 'vec_lifetime \
    insert_value(&amp;mut my_vec, &amp;val2); //                  | 'contents_lifetime
                                      //                  |
    println!(&quot;{my_vec:?}&quot;);           //                  /
}</code></pre>
<h2 id="exercise-part-1-the-other-error"><a class="header" href="#exercise-part-1-the-other-error">Exercise Part 1: The Other Error</a></h2>
<p>First, let's look at the other error we got in the last section:</p>
<pre><code>error[E0502]: cannot borrow `my_vec` as immutable because it is also borrowed as mutable
  --&gt; /tmp/rust.rs:13:16
   |
10 |     insert_value(&amp;mut my_vec, &amp;val1);
   |                  ----------- mutable borrow occurs here
...
13 |     println!(&quot;{my_vec:?}&quot;);
   |                ^^^^^^
   |                |
   |                immutable borrow occurs here
   |                mutable borrow later used here
   |
</code></pre>
<p>Can you explain why this error occurs? Write it out in 50 words or less.</p>
<h2 id="exercise-part-2-writing-our-own"><a class="header" href="#exercise-part-2-writing-our-own">Exercise Part 2: Writing Our Own</a></h2>
<p>Add appropriate lifetimes to the function in the exercise.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="chapter_3.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="chapter_5.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="chapter_3.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="chapter_5.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
